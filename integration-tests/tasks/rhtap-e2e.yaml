---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: rhtap-e2e-runner
spec:
  params:
    - name: ocp-login-command
      type: string
      description: Command to log in to the OpenShift cluster where the tests will be executed.
    - name: oci-container
      type: string
      description: The URI of the OCI container registry to store test artifacts.
      default: "quay.io/konflux-test-storage/rhtap-team/rhtap-e2e"
    - name: rhtap-e2e-container
      type: string
      default: "quay.io/rhtap/rhtap-e2e:latest"
    - name: job-spec
      type: string
      description: "The job specification containing details of the test execution."
  volumes:
    - name: rhtap-cli-volume
      secret: 
        secretName: rhtap-cli-install
    - name: konflux-test-infra-volume
      secret:
        secretName: konflux-test-infra
  steps:
    - name: e2e-test
      image: $(params.rhtap-e2e-container)
      volumeMounts:
        - name: rhtap-cli-volume
          mountPath: /usr/local/rhtap-cli-install
        - name:  konflux-test-infra-volume
          mountPath: /usr/local/konflux-test-infra
      env:
        - name: OCI_CONTAINER
          value: $(params.oci-container)
        - name: JOB_SPEC
          value: $(params.job-spec)
      script: |
        #!/bin/sh

        set -o errexit
        set -o nounset
        set -o pipefail

        # Log into OpenShift
        $(params.ocp-login-command)

        export GIT_REPO="$(echo "$JOB_SPEC" | jq -r '.git.git_repo')"

        if [ "$GIT_REPO" = "rhtap-e2e" ]; then
          export SOURCE_REPO_URL="$(echo "$JOB_SPEC" | jq -r '.git.source_repo_url' | sed 's#https://github.com/##')"
          export SOURCE_REPO_BRANCH="$(echo "$JOB_SPEC" | jq -r '.git.source_repo_branch')"

          echo -e "[INFO] Running e2e tests from source: $SOURCE_REPO_URL and branch $SOURCE_REPO_BRANCH"
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/$SOURCE_REPO_URL/$SOURCE_REPO_BRANCH/integration-tests/scripts/rhtap-e2e-runner.sh)"
        else
          echo -e "[INFO] Running e2e tests from source: redhat-appstudio/rhtap-e2e and branch main"
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/redhat-appstudio/rhtap-e2e/main/integration-tests/scripts/rhtap-e2e-runner.sh)"
        fi
